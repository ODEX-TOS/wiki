<!--
    title: MariaDB
    description: Migration of MariaDB from the arch Wiki to the TOS Wiki
    published: true
    date: 2020-05-28T17:44:33.000Z
    tags: 
    -->>

<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	
	<div class="mw-indicators mw-body-content">
</div>

	<h1 id="firstHeading"  lang="en">MariaDB</h1>
	
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" >From TOS Wiki</div>
		<div id="contentSub"></div>
		
		
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#p-search">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="../PhpMyAdmin.html" title="PhpMyAdmin">phpMyAdmin</a></li>
<li><a href="../Adminer.html" title="Adminer">Adminer</a></li>
<li><a href="../JDBC_and_MySQL.html" title="JDBC and MySQL">JDBC and MySQL</a></li>
<li><a href="../Open_Database_Connectivity.html" title="Open Database Connectivity">Open Database Connectivity</a></li>
</ul>
</div>
<p><a href="https://en.wikipedia.org/wiki/MariaDB"  title="wikipedia:MariaDB">MariaDB</a> is a reliable, high performance and full-featured database server which aims to be an 'always Free, backward compatible, drop-in' replacement of <a href="../MySQL.html" title="MySQL">MySQL</a>. Since 2013 MariaDB is TOS Linux's default implementation of MySQL.<a rel="nofollow"  href="https://www.archlinux.org/news/mariadb-replaces-mysql-in-repositories/">[1]</a>
</p>
<div id="toc" >
<input type="checkbox" role="button" id="toctogglecheckbox"  style="display:none"><div  lang="en" dir="ltr">
<h2>Contents</h2>
<span ><label  for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Installation"><span >1</span> <span >Installation</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#Configuration"><span >2</span> <span >Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Add_user"><span >2.1</span> <span >Add user</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Configuration_files"><span >2.2</span> <span >Configuration files</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Enable_auto-completion"><span >2.3</span> <span >Enable auto-completion</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Using_UTF8MB4"><span >2.4</span> <span >Using UTF8MB4</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Increase_character_limit"><span >2.5</span> <span >Increase character limit</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Using_a_TMPFS_for_tmpdir"><span >2.6</span> <span >Using a TMPFS for tmpdir</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Time_zone_tables"><span >2.7</span> <span >Time zone tables</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10">
<a href="#Security"><span >3</span> <span >Security</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#Improve_initial_security"><span >3.1</span> <span >Improve initial security</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Listen_only_on_the_loopback_address"><span >3.2</span> <span >Listen only on the loopback address</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Enable_access_locally_only_via_Unix_sockets"><span >3.3</span> <span >Enable access locally only via Unix sockets</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Grant_remote_access"><span >3.4</span> <span >Grant remote access</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="#Configure_access_to_home_directories"><span >3.5</span> <span >Configure access to home directories</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-16">
<a href="#Maintenance"><span >4</span> <span >Maintenance</span></a>
<ul>
<li class="toclevel-2 tocsection-17"><a href="#Upgrade_databases_on_major_releases"><span >4.1</span> <span >Upgrade databases on major releases</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#Checking,_optimizing_and_repairing_databases"><span >4.2</span> <span >Checking, optimizing and repairing databases</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-19">
<a href="#Backup"><span >5</span> <span >Backup</span></a>
<ul>
<li class="toclevel-2 tocsection-20"><a href="#Compression"><span >5.1</span> <span >Compression</span></a></li>
<li class="toclevel-2 tocsection-21">
<a href="#Non-interactive"><span >5.2</span> <span >Non-interactive</span></a>
<ul>
<li class="toclevel-3 tocsection-22"><a href="#Example_script"><span >5.2.1</span> <span >Example script</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-23"><a href="#Holland_Backup"><span >5.3</span> <span >Holland Backup</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-24">
<a href="#Troubleshooting"><span >6</span> <span >Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-25"><a href="#Unable_to_run_mysql_upgrade_because_MySQL_cannot_start"><span >6.1</span> <span >Unable to run mysql_upgrade because MySQL cannot start</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="#Reset_the_root_password"><span >6.2</span> <span >Reset the root password</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Check_and_repair_all_tables"><span >6.3</span> <span >Check and repair all tables</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Optimize_all_tables"><span >6.4</span> <span >Optimize all tables</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#OS_error_22_when_running_on_ZFS"><span >6.5</span> <span >OS error 22 when running on ZFS</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Cannot_login_through_CLI,_but_phpmyadmin_works_well"><span >6.6</span> <span >Cannot login through CLI, but phpmyadmin works well</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#MySQL_binary_logs_are_taking_up_huge_disk_space"><span >6.7</span> <span >MySQL binary logs are taking up huge disk space</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#OpenRC_fails_to_start_MySQL"><span >6.8</span> <span >OpenRC fails to start MySQL</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#Specified_key_was_too_long"><span >6.9</span> <span >Specified key was too long</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Changed_limits_warning_on_max_open_files/table_open_cache"><span >6.10</span> <span >Changed limits warning on max_open_files/table_open_cache</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-35"><a href="#See_also"><span >7</span> <span >See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p><a rel="nofollow"  href="https://mariadb.com/">MariaDB</a> is the <a rel="nofollow"  href="https://www.archlinux.org/news/mariadb-replaces-mysql-in-repositories/">default implementation</a> of MySQL in TOS Linux, provided with the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=mariadb">mariadb</a></span> package.
</p>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> 
<ul>
<li>If the database (in <code>/var/lib/mysql</code>) resides on a <a href="../Btrfs.html" title="Btrfs">Btrfs</a> file system, you should consider disabling <a href="../Btrfs.html#Copy-on-Write_(CoW)" title="Btrfs">Copy-on-Write</a> for the directory before creating any database.</li>
<li>If the database resides on a <a href="../ZFS.html" title="ZFS">ZFS</a> file system, you should consult <a href="../ZFS.html#Databases" title="ZFS">ZFS#Databases</a> before creating any database.</li>
</ul>
</div>
<p>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=mariadb">mariadb</a></span>, and run the following command <b>before starting</b> the <code>mariadb.service</code>:
</p>
<pre># mariadb-install-db --user=mysql --basedir=/usr --datadir=/var/lib/mysql
</pre>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If you use something different from <code>/var/lib/mysql</code> for your data dir, you need to set <code>datadir=&lt;YOUR_DATADIR&gt;</code> under section <code>[mysqld]</code> of your <code>/etc/my.cnf.d/server.cnf</code>.</div>
<p>Now the <code>mariadb.service</code> can be started and/or enabled with <a href="../Systemd.html#Using_units" title="Systemd">systemd</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Before continuing, it is recommended to <a href="#Improve_initial_security">improve the initial security</a> of the MySQL installation.</div>
<p>To simplify administration, you might want to install a <a href="../MySQL.html#Graphical_tools" title="MySQL">front-end</a>.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" ><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" ><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The main /etc/my.cnf configuration file is now split into various files in /etc/my.cnf.d/ dir. (Discuss in <a rel="nofollow"  href="https://wiki.archlinux.org/index.php/Talk:MariaDB">Talk:MariaDB#</a>)</div>
</div>
<p>Once you have started the MySQL server and added a root account, you may want to change the default configuration.
</p>
<p>To log in as <code>root</code> on the MySQL server, use the following command:
</p>
<pre># mysql -u root -p
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The default password is empty. Press Enter to log in.</div>
<h3><span class="mw-headline" id="Add_user">Add user</span></h3>
<p>Creating a new user takes two steps: create the user; grant privileges. In the below example, the user <i>monty</i> with <i>some_pass</i> as password is being created, then granted full permissions to the database <i>mydb</i>: 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ mysql -u root -p</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">MariaDB&gt; CREATE USER 'monty'@'localhost' IDENTIFIED BY 'some_pass';
MariaDB&gt; GRANT ALL PRIVILEGES ON mydb.* TO 'monty'@'localhost';
MariaDB&gt; FLUSH PRIVILEGES;
MariaDB&gt; quit</pre>
<h3><span class="mw-headline" id="Configuration_files">Configuration files</span></h3>
<p><i>MariaDB</i> configuration options are read from the following files in the given order (according to <code>mysqld --help --verbose </code> output):
</p>
<pre>/etc/my.cnf /etc/my.cnf.d/ ~/.my.cnf
</pre>
<p>Depending on the scope of the changes you want to make (system-wide, user-only...), use the corresponding file. See <a rel="nofollow"  href="https://mariadb.com/kb/library/configuring-mariadb-with-option-files/">this entry</a> of the Knowledge Base for more information.
</p>
<h3><span class="mw-headline" id="Enable_auto-completion">Enable auto-completion</span></h3>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Enabling this feature can make the client initialization longer.</div>
<p>The MySQL client completion feature is disabled by default. To enable it system-wide edit <code>/etc/mysql/my.cnf</code>, and replace <code>no-auto-rehash</code> by <code>auto-rehash</code> (or add if it doesn't exist). Note that this must be placed under <code>mysql</code> and not <code>mysqld</code>. Completion will be enabled next time you run the MySQL client.
</p>
<h3><span class="mw-headline" id="Using_UTF8MB4">Using UTF8MB4</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Before changing the character set be sure to create a backup first.</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=mariadb">mariadb</a></span> package already uses <code>utf8mb4</code> as charset and <code>utf8mb4_unicode_ci</code> as collation. Users using the default (character) settings may want to skip this section.</li>
<li>UTF8MB4 is recommended over UTF-8 since it allows full Unicode support <a rel="nofollow"  href="https://mathiasbynens.be/notes/mysql-utf8mb4">[2]</a> <a rel="nofollow"  href="https://stackoverflow.com/questions/30074492/what-is-the-difference-between-utf8mb4-and-utf8-charsets-in-mysql">[3]</a>.</li>
</ul>
</div>
<p><a href="../Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> the following values to the main configuration file located at <code>/etc/mysql/my.cnf</code>:
</p>
<pre>[client]
default-character-set = utf8mb4

[mysqld]
collation_server = utf8mb4_unicode_ci
character_set_server = utf8mb4

[mysql]
default-character-set = utf8mb4
</pre>
<p><a href="../Systemd.html#Using_units" class="mw-redirect" title="Restart">Restart</a> <code>mariadb.service</code> to apply the changes.
</p>
<p>See <a href="#Maintenance">#Maintenance</a> to optimize and check the database health.
</p>
<h3><span class="mw-headline" id="Increase_character_limit">Increase character limit</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" ><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" ><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> As of 10.3.1 this section is no longer applicable. All 3 options are now enabled by default. <code>innodb_file_format</code> and <code>innodb_large_prefix</code> are deprecated and can no longer be used. The mariadb service will fail to start if either are included in <code>my.cnf</code> (<a rel="nofollow"  href="https://mariadb.com/kb/library/innodb-system-variables/#innodb_file_format">source</a>) (Discuss in <a rel="nofollow"  href="https://wiki.archlinux.org/index.php/Talk:MariaDB">Talk:MariaDB#</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The character-limit depends on the character-set in use <a rel="nofollow"  href="http://mechanics.flite.com/blog/2014/07/29/using-innodb-large-prefix-to-avoid-error-1071/">[4]</a><sup title="Last check status: domain name not resolved">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot"  title="wikipedia:Wikipedia:Link rot">dead link</a> 2020-03-30 ⓘ]</sup> <a rel="nofollow"  href="https://dev.mysql.com/doc/refman/5.5/innodb-parameters.html#sysvar_innodb_large_prefix">[5]</a> <a rel="nofollow"  href="https://easyengine.io/tutorials/mysql/enable-innodb-file-per-table/">[6]</a>.</div>
<p>For InnoDB execute the following commands to support a higher character-limit:
</p>
<pre>mysql&gt; set global innodb_file_format = BARRACUDA;
Query OK, 0 rows affected (0.00 sec)
</pre>
<pre>mysql&gt; set global innodb_file_per_table = ON;
Query OK, 0 rows affected (0.00 sec)
</pre>
<pre>mysql&gt; set global innodb_large_prefix = ON;
Query OK, 0 rows affected (0.00 sec)
</pre>
<p><a href="../Help:Reading.html#Append,_add,_create,_edit" class="mw-redirect" title="Append">Append</a> the following lines in <code>/etc/mysql/my.cnf</code> to always use a higher character-limit:
</p>
<pre>[mysqld]
innodb_file_format = barracuda
innodb_file_per_table = 1
innodb_large_prefix = 1
</pre>
<p><a href="../Systemd.html#Using_units" class="mw-redirect" title="Restart">Restart</a> <code>mariadb.service</code> to apply the changes.
</p>
<p>On table creating append the <code>ROW_FORMAT</code> as seen in the example:
</p>
<pre>mysql&gt; create table if not exists products (
   -&gt;   day date not null,
   -&gt;   product_id int not null,
   -&gt;   dimension1 varchar(500) not null,
   -&gt;   dimension2 varchar(500) not null,
   -&gt;   unique index unique_index (day, product_id, dimension1, dimension2)
   -&gt; ) ENGINE=InnoDB ROW_FORMAT=DYNAMIC;
Query OK, 0 rows affected (0.02 sec)
</pre>
<h3><span class="mw-headline" id="Using_a_TMPFS_for_tmpdir">Using a TMPFS for tmpdir</span></h3>
<p>The directory used by MySQL for storing temporary files is named <i>tmpdir</i>. For example, it is used to perform disk based large sorts, as well as for internal and explicit temporary tables.
</p>
<p>Create the directory with appropriate permissions:
</p>
<pre># mkdir -pv /var/lib/mysqltmp
# chown mysql:mysql /var/lib/mysqltmp
</pre>
<p>Find the id and gid of the <code>mysql</code> user and group:
</p>
<pre>$ id mysql
uid=27(mysql) gid=27(mysql) groups=27(mysql)
</pre>
<p>Add to your <code>/etc/fstab</code> file.
</p>
<pre> tmpfs   /var/lib/mysqltmp   tmpfs   rw,gid=27,uid=27,size=100M,mode=0750,noatime   0 0
</pre>
<p>Add to your <code>/etc/mysql/my.cnf</code> file under the <code>mysqld</code> group:
</p>
<pre> tmpdir      = /var/lib/mysqltmp
</pre>
<p>Then reboot or ( shutdown mysql, mount the tmpdir, start mysql ).
</p>
<h3><span class="mw-headline" id="Time_zone_tables">Time zone tables</span></h3>
<p>Although time zone tables are created during the installation, they are not automatically populated. They need to be populated if you are planning on using CONVERT_TZ() in SQL queries.
</p>
<p>To populate the time zone tables with all the time zones:
</p>
<pre>$ mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql
</pre>
<p>Optionally, you may populate the table with specific time zone files:
</p>
<pre>$ mysql_tzinfo_to_sql &lt;timezone_file&gt; &lt;timezone_name&gt; | mysql -u root -p mysql
</pre>
<h2><span class="mw-headline" id="Security">Security</span></h2>
<h3><span class="mw-headline" id="Improve_initial_security">Improve initial security</span></h3>
<p>The <code>mysql_secure_installation</code> command will interactively guide you through a number of recommended security measures, such as removing anonymous accounts and removing the test database:
</p>
<pre># mysql_secure_installation
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> After running this, please note that TCP port 3306 will still be open, but refusing connections with an error message. To prevent MySQL from listening on an external interface, see the <a href="#Listen_only_on_the_loopback_address">#Listen only on the loopback address</a> and <a href="#Enable_access_locally_only_via_Unix_sockets">#Enable access locally only via Unix sockets</a> sections.</div>
<h3><span class="mw-headline" id="Listen_only_on_the_loopback_address">Listen only on the loopback address</span></h3>
<p>By default, MySQL will listen on the 0.0.0.0 address, which includes all network interfaces. In order to restrict MySQL to listen only to the loopback address, add the following line in <code>/etc/my.cnf.d/server.cnf</code>:
</p>
<pre>[mysqld]
bind-address = 127.0.0.1
</pre>
<h3><span class="mw-headline" id="Enable_access_locally_only_via_Unix_sockets">Enable access locally only via Unix sockets</span></h3>
<p>By default, MySQL is accessible via both Unix sockets and the network. If MySQL is only needed for the localhost, you can improve security by not listening on TCP port 3306, and only listening on Unix sockets instead. To do this, add the following line in <code>/etc/my.cnf.d/server.cnf</code>:
</p>
<pre>[mysqld]
skip-networking
</pre>
<p>You will still be able to log in locally as before, but only using Unix sockets.
</p>
<h3><span class="mw-headline" id="Grant_remote_access">Grant remote access</span></h3>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This is not considered as best practice and may cause security issues. Consider using <a href="../Secure_Shell.html" title="Secure Shell">Secure Shell</a>, <a href="../List_of_applications/Internet.html#Remote_desktop" class="mw-redirect" title="VNC">VNC</a> or <a href="../Category:Virtual_Private_Network.html" class="mw-redirect" title="VPN">VPN</a>, if you want to maintain the MySQL server from another host inside/outside your network.</div>
<p>To allow remote access to the MySQL server, ensure that MySQL has <a href="#Enable_access_locally_only_via_Unix_sockets">networking enabled</a> and is <a href="#Listen_only_on_the_loopback_address">listening on the appropriate interface</a>.
</p>
<p>Grant any MySQL user remote access (example for root):
</p>
<pre># mysql -u root -p
</pre>
<p>Check current users with remote access privileged:
</p>
<pre>SELECT User, Host FROM mysql.user WHERE Host &lt;&gt; 'localhost';
</pre>
<p>Now grant remote access for your user (here root)::
</p>
<pre>GRANT ALL PRIVILEGES ON *.* TO 'root'@'192.168.1.%' IDENTIFIED BY 'my_optional_remote_password' WITH GRANT OPTION;
</pre>
<p>You can change the '%' wildcard to a specific host if you like. The password can be different from user's main password.
</p>
<h3><span class="mw-headline" id="Configure_access_to_home_directories">Configure access to home directories</span></h3>
<p>For security reasons, the systemd service file contains <code>ProtectHome=true</code>, which prevents MariaDB from accessing files under the <code>/home</code>, <code>/root</code> and <code>/run/user</code> hierarchies. The <code>datadir</code> has to be in an accessible location and <a href="../File_permissions_and_attributes.html#Changing_ownership" class="mw-redirect" title="Chown">owned</a> by the <code>mysql</code> user and group.
</p>
<p>You can modify this behavior by creating a supplementary service file as described <a rel="nofollow"  href="https://mariadb.com/kb/systemd/#configuring-access-to-home-directories">here</a>.
</p>
<h2><span class="mw-headline" id="Maintenance">Maintenance</span></h2>
<h3><span class="mw-headline" id="Upgrade_databases_on_major_releases">Upgrade databases on major releases</span></h3>
<p>Upon a major version release of <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=mariadb">mariadb</a></span> (for example mariadb-10.1.10-1 to mariadb-10.1.18-1), it is wise to upgrade databases:
</p>
<pre># mysql_upgrade -u root -p
</pre>
<p>To upgrade from 10.1.x to 10.3.x:
</p>
<ul>
<li>keep the 10.1.x database daemon running</li>
<li>upgrade the package</li>
<li>run <code>mysql_upgrade</code> (from the new package version) against the old still-running daemon. This will produce some error messages; however, the upgrade will succeed.</li>
<li>restart the daemon, so the 10.3.x daemon runs.</li>
</ul>
<p>Alternatively, stop the (old) daemon, run the (new) daemon in safe mode, run <code>mysql_upgrade</code> against that, and then start the (new) daemon as described below in <a href="#Unable_to_run_mysql_upgrade_because_MySQL_cannot_start">troubleshooting</a>.
</p>
<h3>
<span id="Checking.2C_optimizing_and_repairing_databases"></span><span class="mw-headline" id="Checking,_optimizing_and_repairing_databases">Checking, optimizing and repairing databases</span>
</h3>
<p><span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=mariadb">mariadb</a></span> ships with <code>mysqlcheck</code> which can be used to check, repair, and optimize tables within databases from the shell.  See the mysqlcheck man page for more.  Several command tasks are shown:
</p>
<p>To check all tables in all databases:
</p>
<pre>$ mysqlcheck --all-databases -u root -p -c
</pre>
<p>To analyze all tables in all databases:
</p>
<pre>$ mysqlcheck --all-databases -u root -p -a
</pre>
<p>To repair all tables in all databases:
</p>
<pre>$ mysqlcheck --all-databases -u root -p -r
</pre>
<p>To optimize all tables in all databases:
</p>
<pre>$ mysqlcheck --all-databases -u root -p -o
</pre>
<h2><span class="mw-headline" id="Backup">Backup</span></h2>
<p>There are various <a rel="nofollow"  href="https://mariadb.com/kb/mariadb/documentation/backing-up-and-restoring/">tools and strategies</a> to back up your databases.
</p>
<p>If you are using the default InnoDB storage engine, a <a rel="nofollow"  href="https://mariadb.com/kb/mariadb/documentation/clients-and-utilities/backup-restore-and-import/mysqldump/#examples">suggested</a> way of backing up all your bases online while provisioning for <a rel="nofollow"  href="https://dev.mysql.com/doc/refman/5.6/point-in-time-recovery.html">point-in-time recovery</a> (also known as “roll-forward,” when you need to restore an old backup and replay the changes that happened since that backup) is to execute the following command:
</p>
<pre>$ mysqldump --single-transaction --flush-logs --master-data=2 --all-databases -u root -p &gt; all_databases.sql
</pre>
<p>This will prompt for <b>MariaDB's</b> root user's password, which was defined during database <a href="#Configuration">#Configuration</a>.
</p>
<p>Specifying the password on the command line is <a rel="nofollow"  href="https://dev.mysql.com/doc/refman/5.6/password-security-user.html">strongly discouraged</a>, as it exposes it to discovery by other users through the use of <code>ps aux</code> or other techniques. Instead, the aforementioned command will prompt for the specified user's password, concealing it away.
</p>
<h3><span class="mw-headline" id="Compression">Compression</span></h3>
<p>As SQL tables can get pretty large, it is recommended to pipe the output of the aforementioned command in a compression utility like <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=gzip">gzip</a></span>:
</p>
<pre>$ mysqldump --single-transaction --flush-logs --master-data=2 --all-databases -u root -p | gzip &gt; all_databases.sql.gz
</pre>
<p>Decompressing the backup thus created and reloading it in the server is achieved by doing:
</p>
<pre>$ zcat all_databases.sql.gz | mysql -u root -p
</pre>
<p>This will recreate and repopulate all the databases previously backed up (see <a rel="nofollow"  href="https://stackoverflow.com/questions/23180963/restore-all-mysql-database-from-a-all-database-sql-gz-file#comment35453351_23180977">this</a> or <a rel="nofollow"  href="http://www.linuxquestions.org/questions/linux-server-73/how-to-restore-mysqldump-all-databases-backup-892922/">this</a>).
</p>
<h3><span class="mw-headline" id="Non-interactive">Non-interactive</span></h3>
<p>If you want to setup non-interactive backup script for use in <a href="../Cron.html" title="Cron">cron</a> jobs or <a href="../Systemd/Timers.html" class="mw-redirect" title="Systemd/cron functionality">systemd timers</a>, see <a rel="nofollow"  href="https://dev.mysql.com/doc/refman/5.6/option-files.html">option files</a> and <a rel="nofollow"  href="https://stackoverflow.com/a/9293090">this illustration</a> for <i>mysqldump</i>.
</p>
<p>Basically you should add the following section to the relevant <a href="#Configuration_files">configuration file</a>:
</p>
<pre>[mysqldump]
user=mysqluser
password=secret</pre>
<p>Mentioning a user here is optional, but doing so will free you from having to mention it on the command line. If you want to set this for all tools, including <code>mysql</code>, use the <code>[client]</code> group.
</p>
<h4><span class="mw-headline" id="Example_script">Example script</span></h4>
<p>The database can be dumped to a file for easy backup. The following shell script will do this for you, creating a <code>db_backup.gz</code> file in the same directory as the script, containing your database dump:
</p>
<pre>#!/bin/bash

THISDIR=$(dirname $(readlink -f "$0"))

mysqldump --single-transaction --flush-logs --master-data=2 --all-databases \
 | gzip &gt; $THISDIR/db_backup.gz
echo 'purge master logs before date_sub(now(), interval 7 day);' | mysql
</pre>
<p>See also the official <code>mysqldump</code> page in the <a rel="nofollow"  href="http://dev.mysql.com/doc/refman/5.6/mysqldump.html">MySQL</a> and <a rel="nofollow"  href="https://mariadb.com/kb/mariadb/documentation/clients-and-utilities/backup-restore-and-import/mysqldump">MariaDB</a> manuals.
</p>
<h3><span class="mw-headline" id="Holland_Backup">Holland Backup</span></h3>
<p>A python-based software package named <a rel="nofollow"  href="http://hollandbackup.org/">Holland Backup</a> is available in <a href="../TOS_User_Repository.html" class="mw-redirect" title="AUR">AUR</a> to automate all of the backup work. It supports direct mysqldump, LVM snapshots to tar files (mysqllvm), LVM snapshots with mysqldump (mysqldump-lvm), and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=xtrabackup">xtrabackup</a></span> methods to extract the data. The Holland framework supports a multitude of options and is highly configurable to address almost any backup situation.
</p>
<p>The main <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://aur.archlinux.org/packages/holland/">holland</a></span><sup><small>AUR</small></sup> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://aur.archlinux.org/packages/holland-common/">holland-common</a></span><sup><small>AUR</small></sup> packages provide the core framework; one of the sub-packages (<span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://aur.archlinux.org/packages/holland-mysqldump/">holland-mysqldump</a></span><sup><small>AUR</small></sup>, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://aur.archlinux.org/packages/holland-mysqllvm/">holland-mysqllvm</a></span><sup><small>AUR</small></sup> and/or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://aur.archlinux.org/packages/holland-xtrabackup/">holland-xtrabackup</a></span><sup><small>AUR</small></sup> must be installed for full operation. Example configurations for each method are in the <code>/usr/share/doc/holland/examples/</code> directory and can be copied to <code>/etc/holland/backupsets/</code>, as well as using the <code>holland mk-config</code> command to generate a base config for a named provider.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="Unable_to_run_mysql_upgrade_because_MySQL_cannot_start">Unable to run mysql_upgrade because MySQL cannot start</span></h3>
<p>Try run MySQL in safemode:
</p>
<pre># mysqld_safe --datadir=/var/lib/mysql/
</pre>
<p>And then run:
</p>
<pre># mysql_upgrade -u root -p
</pre>
<h3><span class="mw-headline" id="Reset_the_root_password">Reset the root password</span></h3>
<ol>
<li>Stop <code>mariadb.service</code>.</li>
<li>Start the mysqld server with safety features: <pre># mysqld_safe --skip-grant-tables &amp;</pre>
</li>
<li>Connect to it: <pre># mysql -u root</pre>
</li>
<li>Change root password: <pre>MariaDB [(none)]&gt; use mysql
MariaDB [mysql]&gt; flush privileges;
MariaDB [mysql]&gt; set password for 'root'@'localhost' = password('MyNewPass');
MariaDB [mysql]&gt; exit
</pre>
</li>
<li>Kill running mysqld* processes: <pre># killall -r -9 "mysqld.*"</pre>
</li>
<li>Start <code>mariadb.service</code>.</li>
</ol>
<h3><span class="mw-headline" id="Check_and_repair_all_tables">Check and repair all tables</span></h3>
<p>Check and auto repair all tables in all databases, <a rel="nofollow"  href="http://dev.mysql.com/doc/refman/5.7/mysqlcheck.html">see more</a>:
</p>
<pre># mysqlcheck -A --auto-repair -u root -p
</pre>
<h3><span class="mw-headline" id="Optimize_all_tables">Optimize all tables</span></h3>
<p>Forcefully optimize all tables, automatically fixing table errors that may come up.
</p>
<pre># mysqlcheck -A --auto-repair -f -o -u root -p
</pre>
<h3><span class="mw-headline" id="OS_error_22_when_running_on_ZFS">OS error 22 when running on ZFS</span></h3>
<p>If using MySQL databases on <a href="../ZFS.html" title="ZFS">ZFS</a>, the error <b>InnoDB: Operating system error number 22 in a file operation</b> may occur.
</p>
<p>A workaround is to disable <i>aio_writes</i> in <code>/etc/mysql/my.cnf</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mysql/my.cnf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[mysqld]
innodb_use_native_aio = 0</pre>
<h3>
<span id="Cannot_login_through_CLI.2C_but_phpmyadmin_works_well"></span><span class="mw-headline" id="Cannot_login_through_CLI,_but_phpmyadmin_works_well">Cannot login through CLI, but phpmyadmin works well</span>
</h3>
<p>This may happen if you are using a long (&gt;70-75) password. As for 5.5.36, for some reason, mysql CLI cannot handle that many characters in readline mode. So, if you are planning to use the recommended password input mode:
</p>
<pre>$ mysql -u &lt;user&gt; -p
Password:
</pre>
<p>Consider changing the password to smaller one.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> You still can log in by specifying the password as an argument to mysql command.
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This behavior is considered dangerous, because your password might leak, for example, to the logs. Use it only in case of emergency and do not forget to change password right afterwards.</div>
<pre>$ mysql -u &lt;user&gt; -p"&lt;some-very-strong-password&gt;"
</pre>
</div>
<h3><span class="mw-headline" id="MySQL_binary_logs_are_taking_up_huge_disk_space">MySQL binary logs are taking up huge disk space</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" ><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" ><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" decoding="async" width="48" height="48"></a></p>
<div>
<b>Reason:</b> <span style="color:red;">please use the first argument of the template to provide a brief explanation.</span> (Discuss in <a rel="nofollow"  href="https://wiki.archlinux.org/index.php/Talk:MariaDB#Mistakes_in_">"MySQL_binary_logs_are_taking_up_huge_disk_space" Talk:MariaDB#Mistakes in "MySQL binary logs are taking up huge disk space"</a>)</div>
</div>
<p>By default, mysqld creates binary log files in <code>/var/lib/mysql</code>. This is useful for replication master server or data recovery. But these binary logs can eat up your disk space. If you do not plan to use replication or data recovery features, you may disable binary logging by commenting out these lines in <code>/etc/mysql/my.cnf</code>:
</p>
<pre>#log-bin=mysql-bin
#binlog_format=mixed
</pre>
<p>Or you could limit the size of the logfile like this:
</p>
<pre>expire_logs_days = 10
max_binlog_size  = 100M
</pre>
<p>Alternatively, you can purge some binary logs in <code>/var/lib/mysql</code> to free up disk space with this command:
</p>
<pre># mysql -u root -p"PASSWORD" -e "PURGE BINARY LOGS TO 'mysql-bin.0000xx';"
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> This may decrease the chances of successful data recovery when trying to repair database tables (i.e. on database corruption).</div>
<h3><span class="mw-headline" id="OpenRC_fails_to_start_MySQL">OpenRC fails to start MySQL</span></h3>
<p>To use MySQL with <a href="../OpenRC.html" title="OpenRC">OpenRC</a> you need to add the following lines to the <code>[mysqld]</code> section in the MySQL config file, located at <code>/etc/mysql/my.cnf</code>.
</p>
<pre>user = mysql
basedir = /usr
datadir = /var/lib/mysql
pid-file = /run/mysqld/mysql.pid
</pre>
<p>You should now be able to start MySQL using:
</p>
<pre># rc-service mysql start
</pre>
<h3><span class="mw-headline" id="Specified_key_was_too_long">Specified key was too long</span></h3>
<p>See <a href="#Increase_character_limit">#Increase character limit</a>.
</p>
<h3>
<span id="Changed_limits_warning_on_max_open_files.2Ftable_open_cache"></span><span class="mw-headline" id="Changed_limits_warning_on_max_open_files/table_open_cache">Changed limits warning on max_open_files/table_open_cache</span>
</h3>
<p>Increase the number of file descriptors by creating a <a href="../Systemd.html#Drop-in_files" title="Systemd">systemd drop-in</a>, e.g.:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/systemd/system/mysqld.service.d/limit_nofile.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Service]
LimitNOFILE=8192</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow"  href="https://mariadb.com/">MariaDB Official Website</a></li>
<li><a rel="nofollow"  href="https://mariadb.com/kb/">MariaDB knowledge Base</a></li>
<li><a rel="nofollow"  href="https://www.askapache.com/mysql/performance-tuning-mysql/">MySQL Performance Tuning Scripts and Know-How</a></li>
</ul>
</div></div>
		
		<div id="catlinks"  data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../Category:Relational_DBMSs.html" title="Category:Relational DBMSs">Relational DBMSs</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
<li><a href="../Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li>
</ul>
</div>
</div>
		<div ></div>
		
	</div>
</div>


		<div id="footer" role="contentinfo" style="margin: 0">
						<ul id="footer-info">
								<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=MariaDB&amp;oldid=614757">https://wiki.archlinux.org/index.php?title=MariaDB&amp;oldid=614757</a>"</li>
		
		<li id="footer-info-lastmod"> This page was last edited on 21 May 2020, at 22:17.</li>
								<li id="footer-info-copyright">Content is available under <a  rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
							<br>
</ul>
						<ul id="footer-places">
								<li id="footer-places-privacy"><a href="../TOS Wiki:Privacy_policy.html" title="TOS Wiki:Privacy policy">Privacy policy</a></li>
								<li id="footer-places-about"><a href="../TOS Wiki:About.html" title="TOS Wiki:About">About TOS Wiki</a></li>
								<li id="footer-places-disclaimer"><a href="../TOS Wiki:General_disclaimer.html" title="TOS Wiki:General disclaimer">Disclaimers</a></li>
							</ul>
										<ul id="footer-icons" >
										<li id="footer-copyrightico">
											</li>
									</ul>
						<div style="clear: both;"></div>
		</div>
		



