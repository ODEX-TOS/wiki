<!--
    title: Python_package_guidelines
    description: Migration of Python_package_guidelines from the arch Wiki to the TOS Wiki
    published: true
    date: 2020-05-28T17:44:33.000Z
    tags: 
    -->>

<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	
	<div class="mw-indicators mw-body-content">
</div>

	<h1 id="firstHeading"  lang="en">Python package guidelines</h1>
	
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" >From TOS Wiki</div>
		<div id="contentSub"></div>
		
		
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#p-search">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output">
<div  style="display:block; text-align: center; margin-bottom: 1em;">
<b><a href="../TOS_package_guidelines.html" title="TOS package guidelines">TOS package guidelines</a></b>
<hr>
<p><a href="../32-bit_package_guidelines.html" title="32-bit package guidelines">32-bit</a> – <a href="../CLR_package_guidelines.html" title="CLR package guidelines">CLR</a> – <a href="../CMake_package_guidelines.html" title="CMake package guidelines">CMake</a> – <a href="../Cross-compiling_tools_package_guidelines.html" title="Cross-compiling tools package guidelines">Cross</a> – <a href="../Eclipse_plugin_package_guidelines.html" title="Eclipse plugin package guidelines">Eclipse</a> – <a href="../Electron_package_guidelines.html" title="Electron package guidelines">Electron</a> – <a href="../Font_package_guidelines.html" class="mw-redirect" title="Font packaging guidelines">Font</a> – <a href="../Free_Pascal_package_guidelines.html" title="Free Pascal package guidelines">Free Pascal</a> – <a href="../GNOME_package_guidelines.html" title="GNOME package guidelines">GNOME</a> – <a href="../Go_package_guidelines.html" title="Go package guidelines">Go</a> – <a href="../Haskell_package_guidelines.html" title="Haskell package guidelines">Haskell</a> – <a href="../Java_package_guidelines.html" title="Java package guidelines">Java</a> – <a href="../KDE_package_guidelines.html" title="KDE package guidelines">KDE</a> – <a href="../Kernel_module_package_guidelines.html" title="Kernel module package guidelines">Kernel</a> – <a href="../Lisp_package_guidelines.html" title="Lisp package guidelines">Lisp</a> – <a href="../MinGW_package_guidelines.html" title="MinGW package guidelines">MinGW</a> – <a href="../Node.js_package_guidelines.html" title="Node.js package guidelines">Node.js</a> – <a href="../Nonfree_applications_package_guidelines.html" title="Nonfree applications package guidelines">Nonfree</a> – <a href="../OCaml_package_guidelines.html" title="OCaml package guidelines">OCaml</a> – <a href="../Perl_package_guidelines.html" title="Perl package guidelines">Perl</a> – <a href="../PHP_package_guidelines.html" title="PHP package guidelines">PHP</a> – <a class="mw-selflink selflink">Python</a> – <a href="../R_package_guidelines.html" title="R package guidelines">R</a> – <a href="../Ruby_Gem_package_guidelines.html" title="Ruby Gem package guidelines">Ruby</a> – <a href="../Rust_package_guidelines.html" title="Rust package guidelines">Rust</a> – <a href="../VCS_package_guidelines.html" title="VCS package guidelines">VCS</a> – <a href="../Web_application_package_guidelines.html" title="Web application package guidelines">Web</a> – <a href="../Wine_package_guidelines.html" title="Wine package guidelines">Wine</a>
</p>
</div>
<p>This document covers standards and guidelines on writing <a href="../PKGBUILD.html" title="PKGBUILD">PKGBUILDs</a> for <a href="../Python.html" title="Python">Python</a> software.
</p>
<div id="toc" >
<input type="checkbox" role="button" id="toctogglecheckbox"  style="display:none"><div  lang="en" dir="ltr">
<h2>Contents</h2>
<span ><label  for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Package_naming"><span >1</span> <span >Package naming</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#TOSitecture"><span >2</span> <span >TOSitecture</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Source"><span >3</span> <span >Source</span></a></li>
<li class="toclevel-1 tocsection-4">
<a href="#Installation_methods"><span >4</span> <span >Installation methods</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#distutils"><span >4.1</span> <span >distutils</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#setuptools"><span >4.2</span> <span >setuptools</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#pip"><span >4.3</span> <span >pip</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Build-time_2to3_translation"><span >4.4</span> <span >Build-time 2to3 translation</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#pyproject.toml_(PEP_517)"><span >4.5</span> <span >pyproject.toml (PEP 517)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#Check"><span >5</span> <span >Check</span></a></li>
<li class="toclevel-1 tocsection-11">
<a href="#Tips_and_tricks"><span >6</span> <span >Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-12"><a href="#Discovering_detached_PGP_signatures_on_PyPi"><span >6.1</span> <span >Discovering detached PGP signatures on PyPi</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Using_site-packages"><span >6.2</span> <span >Using site-packages</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Test_directory_in_site-package"><span >6.3</span> <span >Test directory in site-package</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Package_naming">Package naming</span></h2>
<p>For <a href="../Python.html#Python_3" title="Python">Python 3</a> library modules, use <code>python-<i>modulename</i></code>. Also use the prefix if the package provides a program that is strongly coupled to the Python ecosystem (e.g. <i>pip</i> or <i>tox</i>). For other applications, use only the program name.
</p>
<p>The same applies to Python 2 except that the prefix (if needed) is <code>python2-</code>.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The package name should be entirely lowercase.</div>
<h2><span class="mw-headline" id="TOSitecture">TOSitecture</span></h2>
<p>See <a href="../PKGBUILD.html#arch" title="PKGBUILD">PKGBUILD#arch</a>.
</p>
<p>A Python package that contains C extensions using the <code>ext_modules</code> keyword in <code>setup.py</code>, is architecture-dependent. Otherwise it is most likely architecture-independent.
</p>
<h2><span class="mw-headline" id="Source">Source</span></h2>
<p>Download URLs linked from the PyPI website include an unpredictable hash that needs to be fetched from the PyPI website each time a package must be updated. This makes them unsuitable for use in a PKGBUILD. PyPI <a rel="nofollow"  href="https://github.com/pypa/pypi-legacy/issues/438#issuecomment-226940730">provides</a> an alternative stable scheme: <a href="../PKGBUILD.html#source" title="PKGBUILD">PKGBUILD#source</a> <code>source=()</code> array should use the following URL templates:
</p>
<dl>
<dt>Source package</dt>
<dd></dd>
<dd><code>https://files.pythonhosted.org/packages/source/${_name::1}/$_name/$_name-$pkgver.tar.gz</code></dd>
<dt>Pure Python wheel package</dt>
<dd>
<code>https://files.pythonhosted.org/packages/py2.py3/${_name::1}/$_name/${_name/-/_}-$pkgver-py2.py3-none-any.whl</code> (Bilingual – Python 2 and Python 3 compatible)</dd>
<dd>
<code>https://files.pythonhosted.org/packages/py3/${_name::1}/$_name/${_name/-/_}-$pkgver-py3-none-any.whl</code> (Python 3 only)</dd>
<dd>Note that the distribution name can contain dashes, while its representation in a wheel filename cannot (they are converted to underscores).</dd>
<dt>TOS specific wheel package</dt>
<dd>in this example for <code>source_x86_64=('...')</code>. Also <code>_py=cp38</code> can be used to not repeat the python version:</dd>
<dd><code>https://files.pythonhosted.org/packages/$_py/${_name::1}/$_name/${_name/-/_}-$pkgver-$_py-${_py}m-manylinux1_x86_64.whl</code></dd>
</dl>
<p>Note that a custom <code><b>_name</b></code> variable is used instead of <code>pkgname</code> since python packages are generally prefixed with <code>python-</code>. This variable can generically be defined as follows:
</p>
<pre>_name=${pkgname#python-}
</pre>
<h2><span class="mw-headline" id="Installation_methods">Installation methods</span></h2>
<p>Python packages are generally installed using language-specific tools, such as <a rel="nofollow"  href="https://pip.pypa.io/">pip</a> or <a rel="nofollow"  href="https://setuptools.readthedocs.io/latest/easy_install.html">easy_install</a>, which are comparable to dedicated package managers in that they are designed to fetch the source files from an online repository (usually <a rel="nofollow"  href="https://pypi.org/">PyPI</a>, the Python Package Index) and track the relevant files (for a detailed comparison between the two, see <a rel="nofollow"  href="https://packaging.python.org/pip_easy_install/#pip-vs-easy-install">pip vs easy_install</a>).
</p>
<p>However, for managing Python packages from within PKGBUILDs, the standard-provided <a rel="nofollow"  href="http://docs.python.org/library/distutils.html">distutils</a> proves to be the most convenient solution since it uses the downloaded source package's <code>setup.py</code> and easily installs files under <code><i>$pkgdir</i>/usr/lib/python<i>&lt;python version&gt;</i>/site-packages/<i>$pkgname</i></code> directory.
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> Dependencies from <code>setup.py</code> must be defined in the <code>depends</code> array otherwise they will not be installed.</div>
<h3><span class="mw-headline" id="distutils">distutils</span></h3>
<p>A <i>distutils</i> PKGBUILD is usually quite simple:
</p>
<pre>build() {
    <i>python</i> setup.py build
}

package() {
    <i>python</i> setup.py install --root="$pkgdir" --optimize=1 --skip-build
}</pre>
<p>where:
</p>
<ul>
<li>
<i>python</i> is replaced with the proper binary, <code>python</code> or <code>python2</code>
</li>
<li>
<code>--root="$pkgdir"</code> prevents trying to directly install in the host system instead of inside the package file, which would result in a permission error</li>
<li>
<code>--optimize=1</code> compiles optimized bytecode files (<code>.pyo</code> for Python 2, <code>opt-1.pyc</code> for Python 3) so they can be tracked by <a href="../Pacman.html" title="Pacman">pacman</a> instead of being created on the host system on demand</li>
<li>
<code>--skip-build</code> optimizes away the unnecessary attempt to re-run the build steps already run in the <code>build()</code> function.</li>
</ul>
<h3><span class="mw-headline" id="setuptools">setuptools</span></h3>
<p>The Python packaging scene has largely migrated from <i>distutils</i> to <i>setuptools</i>, which is actively developed and functions as a drop-in replacement import in <code>setup.py</code>. The main difference for packagers is that <i>setuptools</i> is packaged separately from Python itself, and must be specified as a <code>makedepends</code>:
</p>
<pre>makedepends=('python-setuptools')
</pre>
<p>If the resulting package includes executables which <a rel="nofollow"  href="https://setuptools.readthedocs.io/latest/setuptools.html#automatic-script-creation">import the <code>pkg_resources</code> module</a>, then <i>setuptools</i> must be additionally specified as a <code>depends</code> in the split <code>package_*()</code> functions; alternatively, if the PKGBUILD only installs the Python package for a single version of Python, <i>setuptools</i> should be moved from <code>makedepends</code> to <code>depends</code>.
</p>
<h3><span class="mw-headline" id="pip">pip</span></h3>
<p>If you need to use <i>pip</i> (provided by <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=python-pip">python-pip</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=python2-pip">python2-pip</a></span>), <i>e.g.</i> for installing <a rel="nofollow"  href="https://github.com/pypa/wheel">wheel</a> packages, remember to pass the following flags:
</p>
<pre>PIP_CONFIG_FILE=/dev/null pip install --isolated --root="$pkgdir" --ignore-installed --no-deps *.whl
</pre>
<ul>
<li>
<code>PIP_CONFIG_FILE=/dev/null</code> ignores <code>{/etc,~/.config}/pip.conf</code> that may be appending arbitrary flags to <b>pip</b>.</li>
<li>
<code>--isolated</code> ignores environment variables (and again <code>{/etc,~/.config}/pip/pip.conf</code>) that may otherwise also be appending arbitrary flags to <b>pip</b>.</li>
<li>
<code>--ignore-installed</code> is necessary until <a rel="nofollow"  href="https://github.com/pypa/pip/issues/3063">https://github.com/pypa/pip/issues/3063</a> is resolved (otherwise <b>pip</b> skips the install in the presence of an earlier <code>--user</code> install).</li>
<li>
<code>--no-deps</code> ensures, that dependencies do not get packaged together with the main package.</li>
</ul>
<p><i>pip</i> doesn't know how to generate <code>.pyo</code> files (see <a rel="nofollow"  href="https://github.com/pypa/pip/issues/2209">https://github.com/pypa/pip/issues/2209</a>). In order to generate them manually after <i>pip</i> has installed the module, run:
</p>
<pre>python -O -m compileall "${pkgdir}/path/to/module"
</pre>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Use of <i>pip</i> and/or wheel packages is discouraged in favor of setuptools source packages, and should only be used when the latter is not a viable option (for example, packages which <b>only</b> come with wheel sources, and therefore cannot be installed using setuptools).</div>
<h3><span class="mw-headline" id="Build-time_2to3_translation">Build-time 2to3 translation</span></h3>
<p>Most Python projects target either Python 2 or Python 3, or target both using compatibility layers like <a rel="nofollow"  href="https://pythonhosted.org/six/">six</a><sup title="Last check status: 404">[<a href="https://en.wikipedia.org/wiki/Wikipedia:Link_rot"  title="wikipedia:Wikipedia:Link rot">dead link</a> 2020-04-01 ⓘ]</sup>. However, some use the deprecated 2to3 keyword in setuptools to heuristically convert the source code from Python 2 to Python 3 at build time. As a result, the same source directories cannot be used to build both Python 2 and Python 3 split packages.
</p>
<p>For packages that do this, we need a <a href="../Creating_packages.html#prepare.28.29" title="Creating packages">prepare()</a> function that copies the source before it is built. Then the Python 2 and Python 3 packages can be converted and built independently without overriding each other.
</p>
<pre>makedepends=("python-setuptools" "python2-setuptools")

prepare() {
    cp -a foo-$pkgver{,-py2}
}

build() {
    cd "$srcdir/foo-$pkgver"
    python setup.py build

    cd "$srcdir/foo-$pkgver-py2"
    python2 setup.py build
}

package_python-foo() {
    depends=("python")
    cd "$srcdir/foo-$pkgver"
    python setup.py install --root="$pkgdir/" --optimize=1 --skip-build
}

package_python2-foo() {
    depends=("python2")
    cd "$srcdir/foo-$pkgver-py2"
    python2 setup.py install --root="$pkgdir/" --optimize=1 --skip-build
}</pre>
<h3>
<span id="pyproject.toml_.28PEP_517.29"></span><span class="mw-headline" id="pyproject.toml_(PEP_517)">pyproject.toml (PEP 517)</span>
</h3>
<p>If an upstream only provides a <code> pyproject.toml</code> (<a rel="nofollow"  href="https://www.python.org/dev/peps/pep-0517/">PEP 517</a>) in their source tarball, it is possible to convert it to a <code>setup.py</code> and use <a href="#setuptools">#setuptools</a> as usual.
</p>
<p>Add <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=python-dephell">python-dephell</a></span> to <code>makedepends</code> and generate the setuptools integration in <code>prepare()</code>:
</p>
<pre>makedepends=("python-setuptools" "python-dephell")

prepare() {
    cd "$pkgname-$pkgver"
    dephell deps convert --from pyproject.toml --to setup.py
}</pre>
<h2><span class="mw-headline" id="Check">Check</span></h2>
<div class="archwiki-template-box archwiki-template-box-warning">
<strong>Warning:</strong> Avoid using <code>tox</code> to run testsuites as it is explicitly designed to test repeatable configurations downloaded from PyPI while <code>tox</code> is running, and does <b>not</b> test the version that will be installed by the package. This defeats the purpose of having a <i>check</i> function at all.</div>
<p>Most python projects providing a testsuite use nosetests or pytest to run tests with <code>test</code> in the name of the file or directory containing the testsuite. In general, simply running <code>nosetests</code> or <code>pytest</code> is enough to run the testsuite.
</p>
<pre>check(){
    cd "$srcdir/foo-$pkgver"

    # For nosetests
    nosetests

    # For pytest
    pytest
}
</pre>
<p>If there is a compiled C extension, the tests need to be run using a <code>$PYTHONPATH</code>, that reflects the current major and minor version of Python in order to find and load it.
</p>
<pre>check(){
  cd "$pkgname-$pkgver"
  local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
  # For nosetests
  PYTHONPATH="$PWD/build/lib.linux-$CARCH-${python_version}" nosetests

  # For pytest
  PYTHONPATH="$PWD/build/lib.linux-$CARCH-${python_version}" pytest
}</pre>
<p>Some projects provide <code>setup.py</code> entry points for running the test. This works for both <code>pytest</code> and <code>nosetests</code>.
</p>
<pre>check(){
    cd "$srcdir/foo-$pkgver"

    # For nosetests
    python setup.py nosetests

    # For pytest - needs python-pytest-runner
    python setup.py pytest
}
</pre>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Discovering_detached_PGP_signatures_on_PyPi">Discovering detached PGP signatures on PyPi</span></h3>
<p>If detached PGP signatures for a given Python sdist tarball exist, they should be used to verify the tarball.
However, the signature files don't show up directly in the files download section of any given project on pypi.org.
To discover the sdist tarballs and their potential signature files, it's possible to use this service to get an overview per project: <a rel="nofollow"  href="https://pypi.debian.net/">https://pypi.debian.net/</a>
</p>
<p>For <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=python-requests">python-requests</a></span> this would be: <a rel="nofollow"  href="https://pypi.debian.net/requests">https://pypi.debian.net/requests</a>
</p>
<h3><span class="mw-headline" id="Using_site-packages">Using site-packages</span></h3>
<p>Sometimes during building, testing or installation it is required to refer to the system's <code>site-packages</code> directory.
To not hardcode the directory, use a call to the system Python version to retrieve the path and store it in a local variable:
</p>
<pre>check(){
  cd "$pkgname-$pkgver"
  local site_packages=$(python -c "import site; print(site.getsitepackages()[0])")
  ...
}</pre>
<h3><span class="mw-headline" id="Test_directory_in_site-package">Test directory in site-package</span></h3>
<p>Make sure to not install a directory named just <code>tests</code> into <code>site-packages</code> (e.g. <code>/usr/lib/python2.7/site-packages/tests/</code>), as it easily conflicts with other Python packages.
</p>
</div></div>
		
		<div id="catlinks"  data-mw="interface">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../Category:TOS_package_guidelines.html" title="Category:TOS package guidelines">TOS package guidelines</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../Category:Pages_with_dead_links.html" title="Category:Pages with dead links">Pages with dead links</a></li></ul>
</div>
</div>
		<div ></div>
		
	</div>
</div>


		<div id="footer" role="contentinfo" style="margin: 0">
						<ul id="footer-info">
								<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Python_package_guidelines&amp;oldid=610401">https://wiki.archlinux.org/index.php?title=Python_package_guidelines&amp;oldid=610401</a>"</li>
		
		<li id="footer-info-lastmod"> This page was last edited on 3 May 2020, at 22:42.</li>
								<li id="footer-info-copyright">Content is available under <a  rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
							<br>
</ul>
						<ul id="footer-places">
								<li id="footer-places-privacy"><a href="../TOS Wiki:Privacy_policy.html" title="TOS Wiki:Privacy policy">Privacy policy</a></li>
								<li id="footer-places-about"><a href="../TOS Wiki:About.html" title="TOS Wiki:About">About TOS Wiki</a></li>
								<li id="footer-places-disclaimer"><a href="../TOS Wiki:General_disclaimer.html" title="TOS Wiki:General disclaimer">Disclaimers</a></li>
							</ul>
										<ul id="footer-icons" >
										<li id="footer-copyrightico">
											</li>
									</ul>
						<div style="clear: both;"></div>
		</div>
		



