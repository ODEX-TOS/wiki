<!--
    title: GitLab
    description: Migration of GitLab from the arch Wiki to the TOS Wiki
    published: true
    date: 2020-05-29T19:25:31.000Z
    tags: 
    -->>

<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	
	<div class="mw-indicators mw-body-content">
</div>

	<h1 id="firstHeading"  lang="en">GitLab</h1>
	
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" >From TOS Wiki</div>
		<div id="contentSub"></div>
		
		
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#p-search">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output">
<div class="archwiki-template-meta-related-articles-start">
<p>Related articles</p>
<ul>
<li><a href="/Usage/Configuration/G/Gitolite.html" title="Gitolite">Gitolite</a></li>
<li><a href="/Usage/Configuration/G/Ruby_on_Rails.html" title="Ruby on Rails">Ruby on Rails</a></li>
</ul>
</div>
<p>From <a rel="nofollow"  href="https://about.gitlab.com/">GitLab's homepage</a>:
</p>
<dl><dd>GitLab offers git repository management, code reviews, issue tracking, activity feeds and wikis. Enterprises install GitLab on-premise and connect it with LDAP and Active Directory servers for secure authentication and authorization. A single GitLab server can handle more than 25,000 users but it is also possible to create a high availability setup with multiple active servers.</dd></dl>
<p>An example live version can be found at <a rel="nofollow"  href="https://gitlab.com/">GitLab.com</a>.
</p>
<div id="toc" >
<input type="checkbox" role="button" id="toctogglecheckbox"  style="display:none"><div  lang="en" dir="ltr">
<h2>Contents</h2>
<span ><label  for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Installation"><span >1</span> <span >Installation</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#Configuration"><span >2</span> <span >Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Preliminary_Notes"><span >2.1</span> <span >Preliminary Notes</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#GitLab"><span >2.2</span> <span >GitLab</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Custom_port_for_Puma"><span >2.3</span> <span >Custom port for Puma</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Secret_strings"><span >2.4</span> <span >Secret strings</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Redis"><span >2.5</span> <span >Redis</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#PostgreSQL_database"><span >2.6</span> <span >PostgreSQL database</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Firewall"><span >2.7</span> <span >Firewall</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#Initialize_Gitlab_database"><span >2.8</span> <span >Initialize Gitlab database</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#Adjust_modifier_bits"><span >2.9</span> <span >Adjust modifier bits</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-12"><a href="#Start_and_test_GitLab"><span >3</span> <span >Start and test GitLab</span></a></li>
<li class="toclevel-1 tocsection-13"><a href="#Upgrade_database_on_updates"><span >4</span> <span >Upgrade database on updates</span></a></li>
<li class="toclevel-1 tocsection-14">
<a href="#Advanced_configuration"><span >5</span> <span >Advanced configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-15"><a href="#Basic_SSH"><span >5.1</span> <span >Basic SSH</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#Custom_SSH_connection"><span >5.2</span> <span >Custom SSH connection</span></a></li>
<li class="toclevel-2 tocsection-17">
<a href="#HTTPS/SSL"><span >5.3</span> <span >HTTPS/SSL</span></a>
<ul>
<li class="toclevel-3 tocsection-18"><a href="#Change_GitLab_configs"><span >5.3.1</span> <span >Change GitLab configs</span></a></li>
<li class="toclevel-3 tocsection-19"><a href="#Let's_Encrypt"><span >5.3.2</span> <span >Let's Encrypt</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-20">
<a href="#Web_server_configuration"><span >5.4</span> <span >Web server configuration</span></a>
<ul>
<li class="toclevel-3 tocsection-21"><a href="#Node.js"><span >5.4.1</span> <span >Node.js</span></a></li>
<li class="toclevel-3 tocsection-22"><a href="#Nginx"><span >5.4.2</span> <span >Nginx</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="#Apache"><span >5.4.3</span> <span >Apache</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-24">
<a href="#Useful_tips"><span >6</span> <span >Useful tips</span></a>
<ul>
<li class="toclevel-2 tocsection-25"><a href="#Rake_tasks"><span >6.1</span> <span >Rake tasks</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="#Backup_and_restore"><span >6.2</span> <span >Backup and restore</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Enable_fast_SSH_key_lookup"><span >6.3</span> <span >Enable fast SSH key lookup</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Sending_mails_from_Gitlab_via_SMTP"><span >6.4</span> <span >Sending mails from Gitlab via SMTP</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-29">
<a href="#Troubleshooting"><span >7</span> <span >Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-30"><a href="#HTTPS_is_not_green_(gravatar_not_using_https)"><span >7.1</span> <span >HTTPS is not green (gravatar not using https)</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Errors_after_updating"><span >7.2</span> <span >Errors after updating</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#GitLab_Puma_cannot_access_non-default_repositories_directory"><span >7.3</span> <span >GitLab Puma cannot access non-default repositories directory</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#Failed_to_connect_to_Gitaly"><span >7.4</span> <span >Failed to connect to Gitaly</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Failed_to_connect_via_SSH"><span >7.5</span> <span >Failed to connect via SSH</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#CSS_or_styles_issue"><span >7.6</span> <span >CSS or styles issue</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-36"><a href="#See_also"><span >8</span> <span >See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> This article covers installing and configuring GitLab without HTTPS at first. If needed, see <a href="#Advanced_configuration">#Advanced configuration</a> to set up SSL.</div>
<p>GitLab requires <a href="/Usage/Configuration/G/Redis.html" title="Redis">Redis</a> and a database backend. If you plan to run it on the same machine, first install <a href="/Usage/Configuration/G/PostgreSQL.html" title="PostgreSQL">PostgreSQL</a>.
</p>
<p><a href="/Usage/Configuration/G/Help:Reading.html#Installation_of_packages" class="mw-redirect" title="Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=gitlab">gitlab</a></span> package.
</p>
<p>In order to receive mail notifications, a mail server must be installed and configured. See <a href="/Usage/Configuration/G/Category:Mail_server.html" title="Category:Mail server">Category:Mail server</a> for details.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<h3><span class="mw-headline" id="Preliminary_Notes">Preliminary Notes</span></h3>
<p>GitLab is composed of multiple components, see the <a rel="nofollow"  href="https://docs.gitlab.com/ce/development/architecture.html">architecture overview page</a>.
</p>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=gitlab">gitlab</a></span> package installs GitLab's files in a manner that more closely follow standard Linux conventions:
</p>
<table >
<tbody>
<tr>
<th>Description
</th>
<th>
<a rel="nofollow"  href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md">GitLab's Official</a>
</th>
<th>
<span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=gitlab">gitlab</a></span>
</th>
</tr>
<tr>
<td>User (Home Directory)
</td>
<td>
<code>git</code> (<code>/home/git</code>)
</td>
<td>
<code>gitlab</code> (<code>/var/lib/gitlab</code>)
</td>
</tr>
<tr>
<td>Configuration File GitShell
</td>
<td>
<code>/home/git/gitlab-shell/config.yml</code>
</td>
<td>
<code>/etc/webapps/gitlab-shell/config.yml</code>
</td>
</tr>
<tr>
<td>Configuration File GitLab
</td>
<td>
<code>/home/git/gitlab/config/gitlab.yml</code>
</td>
<td>
<code>/etc/webapps/gitlab/gitlab.yml</code>
</td>
</tr>
<tr>
<td>Logs
</td>
<td>
<code>/home/git/log</code>
</td>
<td>
<code>/var/log/gitlab</code>
</td>
</tr>
<tr>
<td>Unix socket files / PID files
</td>
<td>
<code>/home/git/sockets</code>
</td>
<td>
<code>/run/gitlab</code>
</td>
</tr>
</tbody>
</table>
<div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> If you are familiar with the <a href="/Usage/Configuration/G/TOS_Build_System.html" title="TOS Build System">TOS Build System</a> you can edit the PKGBUILD and relevant files to change gitlab's home directory to a place of your liking.</div>
<h3><span class="mw-headline" id="GitLab">GitLab</span></h3>
<p>Edit <code>/etc/webapps/gitlab/gitlab.yml</code> and setup at least the following parameters:
</p>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The <code>hostname</code> and <code>port</code> are used for the <code>git clone http://<i>hostname:port</i></code> as example.</div>
<p><b>Hostname:</b> In the <code>gitlab:</code> section set <code>host:</code> - replacing <code>localhost</code> to <code><i>yourdomain.com</i></code> (<b>note:</b> no '<a rel="nofollow"  href="http://'">http://'</a> or trailing slash) - into your fully qualified domain name.
</p>
<p><b>Port:</b> <code>port:</code> can be confusing. This is not the port that the GitLab server (Puma) runs on; it is the port that users will initially access through in their browser. Basically, if you intend for users to visit <code><i>yourdomain.com</i></code> in their browser, without appending a port number to the domain name, leave <code>port:</code> as <code>80</code>. If you intend your users to type something like <code><i>yourdomain.com:3425</i></code> into their browsers, then you would set <code>port:</code> to <code>3425</code>. You will also have to <b>configure your webserver</b> to listen on that port.
</p>
<p><b>Timezone (optional):</b> The <code>time_zone:</code> parameter is optional, but may be useful to force the zone of GitLab applications.
</p>
<h3><span class="mw-headline" id="Custom_port_for_Puma">Custom port for Puma</span></h3>
<p>GitLab Puma is the main component which processes most of the user requests. By default, it listens on the <code>/run/gitlab/gitlab.socket</code> UNIX socket which can be changed in the <code>/etc/webapps/gitlab/puma.rb</code> file.
</p>
<p>To configure Puma to listen on a TCP port as well as UNIX socket:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/webapps/gitlab/puma.rb</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">bind 'unix:///run/gitlab/gitlab.socket'
bind 'tcp://127.0.0.1:8080'</pre>
<p>If the Puma address is changed, the configuration of other components which communicate with Puma have to be updated as well:
</p>
<ul><li>For GitLab Shell, update the <code>gitlab_url</code> variable in <code>/etc/webapps/gitlab-shell/config.yml</code> and <code>/etc/gitlab-gitaly/config.toml</code>.</li></ul>
<dl><dd><div class="archwiki-template-box archwiki-template-box-tip">
<strong>Tip:</strong> According to the comment in the config file, UNIX socket path can be specified with URL-escaped slashes (i.e. <code>http+unix://%2Frun%2Fgitlab%2Fgitlab.socket</code> for the default <code>/run/gitlab/gitlab.socket</code>). Additionally, un-escaped slashes can be used to specify the <a rel="nofollow"  href="https://docs.gitlab.com/ce/install/relative_url.html">relative URL root</a> (e.g. <code>/gitlab</code>).</div></dd></dl>
<ul><li>For GitLab Workhorse, <a href="/Usage/Configuration/G/Systemd.html#Editing_provided_units" class="mw-redirect" title="Edit">edit</a> the <code>gitlab-workhorse.service</code> and update the <code>-authBackend</code> option.</li></ul>
<h3><span class="mw-headline" id="Secret_strings">Secret strings</span></h3>
<p>Make sure that the files <code>/etc/webapps/gitlab/secret</code> and <code>/etc/webapps/gitlab-shell/secret</code> files contain something. Their content should be kept secret because they are used for the generation of authentication tokens etc.
</p>
<p>For example, random strings can be generated with the following commands:
</p>
<pre># hexdump -v -n 64 -e '1/1 "%02x"' /dev/urandom &gt; /etc/webapps/gitlab/secret
# chown root:gitlab /etc/webapps/gitlab/secret
# chmod 640 /etc/webapps/gitlab/secret
</pre>
<pre># hexdump -v -n 64 -e '1/1 "%02x"' /dev/urandom &gt; /etc/webapps/gitlab-shell/secret
# chown root:gitlab /etc/webapps/gitlab-shell/secret
# chmod 640 /etc/webapps/gitlab-shell/secret
</pre>
<p>Also fill in (new) secret strings for <code>secrets.yml</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/webapps/gitlab/secrets.yml</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">production:
  secret_key_base: <i>secret</i>
  db_key_base: <i>secret</i>
</pre>
<h3><span class="mw-headline" id="Redis">Redis</span></h3>
<p>In order to provide sufficient performance you will need a cache database. <a href="/Usage/Configuration/G/Redis.html#Installation" title="Redis">Install</a> and <a href="/Usage/Configuration/G/Redis.html#Configuration" title="Redis">configure</a> a Redis instance, being careful to the section dedicated to listening via a socket.
</p>
<p>Add the <code>gitlab</code> user to the <code>redis</code> <a href="/Usage/Configuration/G/Users_and_groups.html#Group_management" class="mw-redirect" title="User group">user group</a> and update this configuration file:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/webapps/gitlab/resque.yml</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">development:
  url: unix:/run/redis/redis.sock
test:
  url: unix:/run/redis/redis.sock
production:
  url: unix:/run/redis/redis.sock</pre>
<h3><span class="mw-headline" id="PostgreSQL_database">PostgreSQL database</span></h3>
<p>A <a href="/Usage/Configuration/G/PostgreSQL.html" title="PostgreSQL">PostgreSQL</a> database will be required before Gitlab can be run.
</p>
<p>Login to PostgreSQL and create the <code>gitlabhq_production</code> database along with its user. Remember to change <code>your_username_here</code> and <code>your_password_here</code> to the real values:
</p>
<pre># psql -d template1
</pre>
<pre>template1=# CREATE USER your_username_here WITH PASSWORD 'your_password_here';
template1=# ALTER USER your_username_here SUPERUSER;
template1=# CREATE DATABASE gitlabhq_production OWNER your_username_here;
template1=# \q</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> The reason for creating the user as a superuser is that GitLab is trying to be "smart" and install extensions (not just create them in its own userspace). And this is only allowed by superusers in Postgresql.</div>
<p>Try connecting to the new database with the new user to verify it works:
</p>
<pre># psql -d gitlabhq_production
</pre>
<p>Copy the PostgreSQL template file before configuring it:
</p>
<pre># cp /usr/share/doc/gitlab/database.yml.postgresql /etc/webapps/gitlab/database.yml
</pre>
<p>Open the new <code>/etc/webapps/gitlab/database.yml</code> and set the values for <code>username:</code> and <code>password:</code>. For example:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/webapps/gitlab/database.yml</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#
# PRODUCTION
#
production:
  adapter: postgresql
  encoding: unicode
  database: gitlabhq_production
  pool: 10
  username: your_username_here
  password: "your_password_here"
  # host: localhost
  # port: 5432
  socket: /run/postgresql/.s.PGSQL.5432
...
</pre>
<p>For our purposes (unless you know what you are doing), you do not need to worry about configuring the other databases listed in <code>/etc/webapps/gitlab/database.yml</code>. We only need to set up the production database to get GitLab working.
</p>
<h3><span class="mw-headline" id="Firewall">Firewall</span></h3>
<p>If you want to give direct access to your Gitlab installation through an <a href="/Usage/Configuration/G/Iptables.html" title="Iptables">iptables</a> firewall, you may need to adjust the port and the network address:
</p>
<pre># iptables -A tcp_inbound -p TCP -s <b>192.168.1.0/24</b> --destination-port <b>80</b> -j ACCEPT
</pre>
<p>To enable API-access:
</p>
<pre># iptables -A tcp_inbound -p TCP -s <b>192.168.1.0/24</b> --destination-port <b>8080</b> -j ACCEPT
</pre>
<p>If you are behind a router, do not forget to forward this port to the running GitLab server host, if you want to allow WAN-access.
</p>
<h3><span class="mw-headline" id="Initialize_Gitlab_database">Initialize Gitlab database</span></h3>
<p>Start the <a href="/Usage/Configuration/G/Redis.html" title="Redis">Redis</a> server and the <code>gitlab-gitaly.service</code> before initializing the database.
</p>
<p>Initialize the database and activate advanced features:
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; EXECJS_RUNTIME=Disabled bundle exec rake gitlab:setup RAILS_ENV=production"
</pre>
<p>Finally run the following commands to check your installation:
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; EXECJS_RUNTIME=Disabled bundle exec rake gitlab:env:info RAILS_ENV=production"
# su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; EXECJS_RUNTIME=Disabled bundle exec rake gitlab:check RAILS_ENV=production"
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong> 
<ul>
<li>The <i>gitlab:env:info</i> and <i>gitlab:check</i> commands will show a fatal error related to git. This is OK.</li>
<li>The <i>gitlab:check</i> will complain about missing initscripts. This is nothing to worry about, as <a href="/Usage/Configuration/G/Systemd.html" title="Systemd">systemd</a> service files are used instead (which GitLab does not recognize).</li>
</ul>
</div>
<h3><span class="mw-headline" id="Adjust_modifier_bits">Adjust modifier bits</span></h3>
<p>(The gitlab check will not pass if the user and group ownership is not configured properly)
</p>
<pre># chmod -R ug+rwX,o-rwx /var/lib/gitlab/repositories/
# chmod -R ug-s /var/lib/gitlab/repositories
# find /var/lib/gitlab/repositories/ -type d -print0 | xargs -0 chmod g+s
</pre>
<h2><span class="mw-headline" id="Start_and_test_GitLab">Start and test GitLab</span></h2>
<p>Make sure <a href="/Usage/Configuration/G/PostgreSQL.html" title="PostgreSQL">PostgreSQL</a> and <a href="/Usage/Configuration/G/Redis.html" title="Redis">Redis</a> are running and setup correctly.
</p>
<p>Then <a href="/Usage/Configuration/G/Systemd.html#Using_units" class="mw-redirect" title="Start">start</a>/<a href="/Usage/Configuration/G/Systemd.html#Using_units" class="mw-redirect" title="Enable">enable</a> <code>gitlab.target</code>.
</p>
<p>Now test your GitLab instance by visiting <a rel="nofollow"  href="http://localhost:8080">http://localhost:8080</a>; you should be prompted to create a password:
</p>
<pre>username: root
password: You will be prompted to create one on your first visit.
</pre>
<p>To access GitLab from an outside network, the upstream documentation recommends to use an established web server as a proxy. See <a href="#Web_server_configuration">#Web server configuration</a> for details. 
</p>
<p>See <a href="#Troubleshooting">#Troubleshooting</a> and log files inside the <code>/usr/share/webapps/gitlab/log/</code> directory for troubleshooting.
</p>
<h2><span class="mw-headline" id="Upgrade_database_on_updates">Upgrade database on updates</span></h2>
<p>After updating the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=gitlab">gitlab</a></span> package, it is required to upgrade the database:
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; EXECJS_RUNTIME=Disabled bundle exec rake db:migrate RAILS_ENV=production"
</pre>
<p>Afterwards, restart gitlab-related services:
</p>
<pre># systemctl daemon-reload
# systemctl restart gitlab-sidekiq gitlab-puma gitlab-workhorse gitlab-gitaly
</pre>
<h2><span class="mw-headline" id="Advanced_configuration">Advanced configuration</span></h2>
<h3><span class="mw-headline" id="Basic_SSH">Basic SSH</span></h3>
<p>After completing the basic installation, set up SSH access for users.  Configuration for <a href="/Usage/Configuration/G/OpenSSH.html" title="OpenSSH">OpenSSH</a> is described below.  <a href="/Usage/Configuration/G/Secure_Shell.html#Implementations" class="mw-redirect" title="SSH">Other SSH clients and servers</a> will require different modifications.
</p>
<p>For tips on adding user SSH keys, the process is well-documented on the <a rel="nofollow"  href="https://docs.gitlab.com/ee/ssh/">GitLab</a> website.  You can check the administrator logs at <code>/var/lib/gitlab/log/gitlab-shell.log</code> to confirm user SSH keys are being submitted properly.  Behind the scenes, GitLab adds these keys to its <i>authorized_keys</i> file in <code>/var/lib/gitlab/.ssh/authorized_keys</code>.
</p>
<p>The common method of testing keys (ex: <code>$ ssh -T git@<i>YOUR_SERVER</i></code>) requires a bit of extra configuration to work correctly.  The user configured in <code>/etc/webapps/gitlab/gitlab.yml</code> (default user: <code>gitlab</code>) must be added to the server's sshd configuration file, in addition to a handful of other changes:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">PubkeyAuthentication   yes
AuthorizedKeysFile     %h/.ssh/authorized_keys
</pre>
<p>If your <code>/etc/ssh/sshd_config</code> contains <code>AllowUsers</code> option then please add <code>gitlab</code> user to the list:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">AllowUsers gitlab <i>foobar</i>
</pre>
<p>After updating the configuration file, restart the ssh daemon:
</p>
<pre># systemctl restart sshd
</pre>
<p>Test user SSH keys (optionally add -v to see extra information):
</p>
<pre>$ ssh -T <b>gitlab</b>@<i>YOUR_SERVER</i>
</pre>
<h3><span class="mw-headline" id="Custom_SSH_connection">Custom SSH connection</span></h3>
<p>If you are running SSH on a non-standard port, you must change the GitLab user's SSH config:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/var/lib/gitlab/.ssh/config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">host localhost      # Give your setup a name (here: override localhost)
user gitlab         # Your remote git user
port 2222           # Your port number
hostname 127.0.0.1; # Your server name or IP</pre>
<p>You also need to change the corresponding options (e.g. ssh_user, ssh_host, admin_uri) in the <code>/etc/webapps/gitlab/gitlab.yml</code> file.
</p>
<h3>
<span id="HTTPS.2FSSL"></span><span class="mw-headline" id="HTTPS/SSL">HTTPS/SSL</span>
</h3>
<h4><span class="mw-headline" id="Change_GitLab_configs">Change GitLab configs</span></h4>
<p>Modify <code>/etc/webapps/gitlab/shell.yml</code> so the url to your GitLab site starts with <code>https://</code>.
Modify <code>/etc/webapps/gitlab/gitlab.yml</code> so that <code>https:</code> setting is set to <code>true</code>.
</p>
<p>See also <a href="/Usage/Configuration/G/Apache_HTTP_Server.html#TLS" title="Apache HTTP Server">Apache HTTP Server#TLS</a> and <a href="/Usage/Configuration/G/Certbot.html" class="mw-redirect" title="Let’s Encrypt">Let’s Encrypt</a>.
</p>
<h4>
<span id="Let.27s_Encrypt"></span><span class="mw-headline" id="Let's_Encrypt">Let's Encrypt</span>
</h4>
<p>To validate your URL, the Let's Encrypt process will try to access your gitlab server with something like <code>https://gitlab.<i>YOUR_SERVER_FQDN</i>/.well-known/acme-challenge/<i>A_LONG_ID</i></code>. But, due to gitlab configuration, every request to <code>gitlab.<i>YOUR_SERVER_FQDN</i></code> will be redirected to a proxy (gitlab-workhorse) that will not be able to deal with this URL.
</p>
<p>To bypass this issue, you can use the Let's Encrypt webroot configuration, setting the webroot at <code>/srv/http/letsencrypt/</code>.
</p>
<p>Additionally, force the Let's Encrypt request for gitlab to be redirected to this webroot by adding the following:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/http/conf/extra/gitlab.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Alias "/.well-known"  "/srv/http/letsencrypt/.well-known"
RewriteCond   %{REQUEST_URI}  !/\.well-known/.*
</pre>
<h3><span class="mw-headline" id="Web_server_configuration">Web server configuration</span></h3>
<p>If you want to integrate GitLab into a running web server instead of using its build-in HTTP server Puma, follow these instructions.
</p>
<h4><span class="mw-headline" id="Node.js">Node.js</span></h4>
<p>You can easily set up an HTTP proxy on port 443 to proxy traffic to the GitLab application on port 8080 using http-master for Node.js. After you have created your domain's OpenSSL keys and have gotten you CA certificate (or self signed it), then go to <a rel="nofollow"  href="https://github.com/CodeCharmLtd/http-master">https://github.com/CodeCharmLtd/http-master</a> to learn how easy it is to proxy requests to GitLab using HTTPS. http-master is built on top of <a rel="nofollow"  href="https://github.com/nodejitsu/node-http-proxy">node-http-proxy</a>.
</p>
<h4><span class="mw-headline" id="Nginx">Nginx</span></h4>
<p>See <a href="/Usage/Configuration/G/Nginx.html#Configuration" title="Nginx">Nginx#Configuration</a> for basic <i>nginx</i> configuration and <a href="/Usage/Configuration/G/Nginx.html#TLS" title="Nginx">Nginx#TLS</a> for enabling HTTPS. The sample in this section also assumes that server blocks are managed with <a href="/Usage/Configuration/G/Nginx.html#Managing_server_entries" title="Nginx">Nginx#Managing server entries</a>.
</p>
<p>Create and edit the configuration based on the following snippet. See the <a rel="nofollow"  href="https://gitlab.com/gitlab-org/gitlab-ce/tree/master/lib/support/nginx">upstream GitLab repository</a> for more examples.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nginx/servers-available/gitlab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">upstream gitlab-workhorse {
  server unix:/run/gitlab/gitlab-workhorse.socket fail_timeout=0;
}

server {
  listen 80;                  # IPv4 HTTP
  #listen 443 ssl http2;      # uncomment to enable IPv4 HTTPS + HTTP/2
  #listen [::]:80;            # uncomment to enable IPv6 HTTP
  #listen [::]:443 ssl http2; # uncomment to enable IPv6 HTTPS + HTTP/2
  server_name example.com;

  #ssl_certificate ssl/example.com.crt;
  #ssl_certificate_key ssl/example.com.key;

  location / {
      # unlimited upload size in nginx (so the setting in GitLab applies)
      client_max_body_size 0;

      # proxy timeout should match the timeout value set in /etc/webapps/gitlab/puma.rb
      proxy_read_timeout 60;
      proxy_connect_timeout 60;
      proxy_redirect off;

      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Ssl on;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://gitlab-workhorse;
  }

  error_page 404 /404.html;
  error_page 422 /422.html;
  error_page 500 /500.html;
  error_page 502 /502.html;
  error_page 503 /503.html;
  location ~ ^/(404|422|500|502|503)\.html$ {
    root /usr/share/webapps/gitlab/public;
    internal;
  }
}
</pre>
<h4><span class="mw-headline" id="Apache">Apache</span></h4>
<p>Install and configure the <a href="/Usage/Configuration/G/Apache_HTTP_Server.html" title="Apache HTTP Server">Apache HTTP Server</a>. You can use these <a rel="nofollow"  href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/web-server/apache">upstream recipes</a> to get started with the configuration file for GitLab's virtual host.
</p>
<p>For the SSL configuration see <a href="/Usage/Configuration/G/Apache_HTTP_Server.html#TLS" title="Apache HTTP Server">Apache HTTP Server#TLS</a>. If you do not need it, remove it. Notice that the SSL virtual host needs a specific IP instead of generic. Also if you set a custom port for Puma, do not forget to set it at the <code>BalanceMember</code> line.
</p>
<h2><span class="mw-headline" id="Useful_tips">Useful tips</span></h2>
<h3><span class="mw-headline" id="Rake_tasks">Rake tasks</span></h3>
<p>A number of setup/maintenance/etc tasks are available through rake.  To list them, go to Gitlab's home directory:
</p>
<pre># cd /usr/share/webapps/gitlab
</pre>
<p>and run:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># rake -T | grep gitlab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">rake gitlab:app:check                         # GITLAB | Check the configuration of the GitLab Rails app
rake gitlab:backup:create                     # GITLAB | Create a backup of the GitLab system
rake gitlab:backup:restore                    # GITLAB | Restore a previously created backup
rake gitlab:check                             # GITLAB | Check the configuration of GitLab and its environment
rake gitlab:cleanup:block_removed_ldap_users  # GITLAB | Cleanup | Block users that have been removed in LDAP
rake gitlab:cleanup:dirs                      # GITLAB | Cleanup | Clean namespaces
rake gitlab:cleanup:repos                     # GITLAB | Cleanup | Clean repositories
rake gitlab:env:check                         # GITLAB | Check the configuration of the environment
rake gitlab:env:info                          # GITLAB | Show information about GitLab and its environment
rake gitlab:generate_docs                     # GITLAB | Generate sdocs for project
rake gitlab:gitlab_shell:check                # GITLAB | Check the configuration of GitLab Shell
rake gitlab:import:all_users_to_all_groups    # GITLAB | Add all users to all groups (admin users are added as owners)
rake gitlab:import:all_users_to_all_projects  # GITLAB | Add all users to all projects (admin users are added as masters)
rake gitlab:import:repos                      # GITLAB | Import bare repositories from gitlab_shell -&gt; repos_path into GitLab project instance
rake gitlab:import:user_to_groups[email]      # GITLAB | Add a specific user to all groups (as a developer)
rake gitlab:import:user_to_projects[email]    # GITLAB | Add a specific user to all projects (as a developer)
rake gitlab:satellites:create                 # GITLAB | Create satellite repos
rake gitlab:setup                             # GITLAB | Setup production application
rake gitlab:shell:build_missing_projects      # GITLAB | Build missing projects
rake gitlab:shell:install[tag,repo]           # GITLAB | Install or upgrade gitlab-shell
rake gitlab:shell:setup                       # GITLAB | Setup gitlab-shell
rake gitlab:sidekiq:check                     # GITLAB | Check the configuration of Sidekiq
rake gitlab:test                              # GITLAB | Run all tests
rake gitlab:web_hook:add                      # GITLAB | Adds a web hook to the projects
rake gitlab:web_hook:list                     # GITLAB | List web hooks
rake gitlab:web_hook:rm                       # GITLAB | Remove a web hook from the projects
rake setup                                    # GITLAB | Setup gitlab db
</pre>
<h3><span class="mw-headline" id="Backup_and_restore">Backup and restore</span></h3>
<p>Create a backup of the gitlab system:
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; bundle exec rake RAILS_ENV=production gitlab:backup:create"
</pre>
<p>Restore the previously created backup file <code>/var/lib/gitlab/backups/1556571328_2019_04_29_11.10.2_gitlab_backup.tar</code>:
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; bundle exec rake RAILS_ENV=production gitlab:backup:restore BACKUP=1556571328_2019_04_29_11.10.2"
</pre>
<div class="archwiki-template-box archwiki-template-box-note">
<strong>Note:</strong>  Backup folder is set in <code>config/gitlab.yml</code>. GitLab backup and restore is documented <a rel="nofollow"  href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/raketasks/backup_restore.md">here</a>.</div>
<h3><span class="mw-headline" id="Enable_fast_SSH_key_lookup">Enable fast SSH key lookup</span></h3>
<p>Enable Fast SSH Key Lookup as explained in this page: <a rel="nofollow"  href="https://docs.gitlab.com/ee/administration/operations/fast_ssh_key_lookup.html">https://docs.gitlab.com/ee/administration/operations/fast_ssh_key_lookup.html</a>
</p>
<p>In short, edit <code>/etc/ssh/sshd_config</code>.
</p>
<p>Revert all changes done following this wiki (or revert <code>sshd_config</code> from the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow"  href="https://www.archlinux.org/packages/?name=openssh">openssh</a></span> package) and only add:
</p>
<pre>AuthorizedKeysCommand /var/lib/gitlab/gitlab-shell/bin/gitlab-shell-authorized-keys-check gitlab %u %k
AuthorizedKeysCommandUser gitlab
</pre>
<p>Finally <a href="/Usage/Configuration/G/Systemd.html#Using_units" class="mw-redirect" title="Restart">restart</a> the <code>sshd.service</code>.
</p>
<h3><span class="mw-headline" id="Sending_mails_from_Gitlab_via_SMTP">Sending mails from Gitlab via SMTP</span></h3>
<p>You might want to use a gmail (or other mail service) to send mails from your gitlab server. This avoids the need to install a mail daemon on the gitlab server.
</p>
<p>Adjust <code>smtp_settings.rb</code> according to your mail server settings:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/usr/share/webapps/gitlab/config/initializers/smtp_settings.rb</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">if Rails.env.production?
  Gitlab::Application.config.action_mailer.delivery_method = :smtp

  ActionMailer::Base.delivery_method = :smtp
  ActionMailer::Base.smtp_settings = {
    address:              'smtp.gmail.com',
    port:                 587,
    domain:               'gmail.com',
    user_name:            'username@gmail.com',
    password:             'application password',
    authentication:       'plain',
    enable_starttls_auto: true
  }
end</pre>
<p>Gmail will reject mails received this way (and send you a mail that it did). You will need to disable secure authentication (follow the link in the rejection mail) to work around this. The more secure approach is to enable two-factor authentication for username@gmail.com and to set up an application password for this configuration file.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3>
<span id="HTTPS_is_not_green_.28gravatar_not_using_https.29"></span><span class="mw-headline" id="HTTPS_is_not_green_(gravatar_not_using_https)">HTTPS is not green (gravatar not using https)</span>
</h3>
<p>Redis caches gravatar images, so if you have visited your GitLab with http, then enabled https, gravatar will load up the non-secure images. You can clear the cache by doing
</p>
<pre>cd /usr/share/webapps/gitlab
RAILS_ENV=production bundle exec rake cache:clear
</pre>
<p>as the gitlab user.
</p>
<h3><span class="mw-headline" id="Errors_after_updating">Errors after updating</span></h3>
<p>After updating the package from the AUR, the database migrations and asset updates will sometimes fail. These steps may resolve the issue, if a simple reboot does not.
</p>
<p>First, move to the gitlab installation directory.
</p>
<pre># cd /usr/share/webapps/gitlab
</pre>
<p>If every gitlab page gives a 500 error, then the database migrations and the assets are probably stale. If not, skip this step.
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; bundle exec rake db:migrate RAILS_ENV=production"
</pre>
<p>If gitlab is constantly waiting for the deployment to finish, then the assets have probably not been recompiled.
</p>
<pre># su - gitlab -s /bin/sh -c "cd '/usr/share/webapps/gitlab'; bundle exec rake gitlab:assets:clean gitlab:assets:compile cache:clear RAILS_ENV=production"
</pre>
<p>Finally, restart the gitlab services and test your site.
</p>
<pre># systemctl restart gitlab-puma gitlab-sidekiq gitlab-workhorse
</pre>
<h3><span class="mw-headline" id="GitLab_Puma_cannot_access_non-default_repositories_directory">GitLab Puma cannot access non-default repositories directory</span></h3>
<p>If a custom repository storage directory is set in <code>/home</code>, disable the <code>ProtectHome=true</code> parameter in the <code>gitlab-puma.service</code> (see <a href="/Usage/Configuration/G/Systemd.html#Drop-in_files" title="Systemd">systemd#Drop-in files</a> and the <a rel="nofollow"  href="https://forum.gitlab.com/t/cannot-change-repositores-location/9634/2">relevant forum thread on gitlab.com</a>).
</p>
<h3><span class="mw-headline" id="Failed_to_connect_to_Gitaly">Failed to connect to Gitaly</span></h3>
<p>Sometimes, the Gitaly service will not get started, leaving GitLab unable to connect to Gitaly. The solution is simple:
</p>
<pre># systemctl start gitlab-gitaly
</pre>
<h3><span class="mw-headline" id="Failed_to_connect_via_SSH">Failed to connect via SSH</span></h3>
<p>If git operations (-T, pull, clone, etc.) fails using ssh try changing the shell:
</p>
<pre># usermod -s /usr/share/webapps/gitlab-shell/bin/gitlab-shell-ruby gitlab
</pre>
<h3><span class="mw-headline" id="CSS_or_styles_issue">CSS or styles issue</span></h3>
<p>If you have any issues with styles and CSS not working, you may try to edit <code>/usr/share/webapps/gitlab/config/environments/production.rb</code> and change:
</p>
<pre> # Disable Rails's static asset server (Apache or nginx will already do this)
 config.public_file_server.enabled = false
</pre>
<p>to:
</p>
<pre> # Disable Rails's static asset server (Apache or nginx will already do this)
 config.public_file_server.enabled = true
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li><a rel="nofollow"  href="https://docs.gitlab.com/ce/install/installation.html">Official installation documentation</a></li>
<li><a rel="nofollow"  href="https://gitlab.com/gitlab-org/gitlab-recipes">GitLab recipes with further documentation on running it with several web servers</a></li>
<li><a rel="nofollow"  href="https://gitlab.com/gitlab-org/gitlab-ce">GitLab source code</a></li>
</ul>
</div></div>
		
		<div id="catlinks"  data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="/Usage/Configuration/G/Category:Git_web_interfaces.html" title="Category:Git web interfaces">Git web interfaces</a></li></ul>
</div></div>
		<div ></div>
		
	</div>
</div>


		<div id="footer" role="contentinfo" style="margin: 0">
						<ul id="footer-info">
								<li>Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=GitLab&amp;oldid=616397">https://wiki.archlinux.org/index.php?title=GitLab&amp;oldid=616397</a>"</li>
		
		<li id="footer-info-lastmod"> This page was last edited on 26 May 2020, at 17:21.</li>
								<li id="footer-info-copyright">Content is available under <a  rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
							<br>
</ul>
						<ul id="footer-places">
								<li id="footer-places-privacy"><a href="/Usage/Configuration/G/TOS Wiki:Privacy_policy.html" title="TOS Wiki:Privacy policy">Privacy policy</a></li>
								<li id="footer-places-about"><a href="/Usage/Configuration/G/TOS Wiki:About.html" title="TOS Wiki:About">About TOS Wiki</a></li>
								<li id="footer-places-disclaimer"><a href="/Usage/Configuration/G/TOS Wiki:General_disclaimer.html" title="TOS Wiki:General disclaimer">Disclaimers</a></li>
							</ul>
										<ul id="footer-icons" >
										<li id="footer-copyrightico">
											</li>
									</ul>
						<div style="clear: both;"></div>
		</div>
		



